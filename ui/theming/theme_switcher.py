"""
ä¸»é¢˜åˆ‡æ¢å™¨ç»„ä»¶
æä¾›ç®€æ´çš„ä¸»é¢˜åˆ‡æ¢ç•Œé¢
"""
from PySide6.QtWidgets import (QWidget, QHBoxLayout, QVBoxLayout, QComboBox, 
                               QPushButton, QLabel, QFrame)
from PySide6.QtCore import Signal, Qt
from PySide6.QtGui import QFont

from .theme_manager import ThemeManager
from .theme_schema import ThemeMode


class ThemeSwitcherWidget(QFrame):
    """ä¸»é¢˜åˆ‡æ¢å™¨ç»„ä»¶"""
    
    theme_changed = Signal(str)
    mode_changed = Signal(str)
    
    def __init__(self, theme_manager: ThemeManager, parent=None):
        super().__init__(parent)
        self.theme_manager = theme_manager
        self.setup_ui()
        self.connect_signals()
    
    def setup_ui(self):
        """è®¾ç½®ç•Œé¢"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(12, 12, 12, 12)
        layout.setSpacing(8)
        
        # æ ‡é¢˜
        title = QLabel("ä¸»é¢˜è®¾ç½®")
        title.setFont(QFont("Microsoft YaHei", 12, QFont.Weight.Bold))
        layout.addWidget(title)
        
        # ä¸»é¢˜é€‰æ‹©
        theme_layout = QHBoxLayout()
        theme_layout.addWidget(QLabel("ä¸»é¢˜:"))
        
        self.theme_combo = QComboBox()
        self.theme_combo.setMinimumWidth(150)
        theme_layout.addWidget(self.theme_combo)
        
        layout.addLayout(theme_layout)
        
        # æ¨¡å¼é€‰æ‹©
        mode_layout = QHBoxLayout()
        mode_layout.addWidget(QLabel("æ¨¡å¼:"))
        
        self.mode_combo = QComboBox()
        self.mode_combo.addItems(["æµ…è‰²", "æ·±è‰²"])
        self.mode_combo.setMinimumWidth(150)
        mode_layout.addWidget(self.mode_combo)
        
        layout.addLayout(mode_layout)
        
        # åº”ç”¨æŒ‰é’®
        self.apply_btn = QPushButton("åº”ç”¨ä¸»é¢˜")
        layout.addWidget(self.apply_btn)
        
        # åŠ è½½æ•°æ®
        self.refresh_themes()
        self.refresh_current_settings()
    
    def connect_signals(self):
        """è¿æ¥ä¿¡å·"""
        self.apply_btn.clicked.connect(self.apply_theme)
        self.theme_combo.currentTextChanged.connect(self.on_theme_changed)
        self.mode_combo.currentTextChanged.connect(self.on_mode_changed)
        
        # è¿æ¥ä¸»é¢˜ç®¡ç†å™¨çš„ä¿¡å·
        self.theme_manager.theme_changed.connect(self.on_theme_manager_changed)
        self.theme_manager.mode_changed.connect(self.on_mode_manager_changed)
    
    def refresh_themes(self):
        """åˆ·æ–°ä¸»é¢˜åˆ—è¡¨"""
        self.theme_combo.clear()
        themes = self.theme_manager.get_available_themes()
        for theme_id, theme_name in themes.items():
            self.theme_combo.addItem(theme_name, theme_id)
    
    def refresh_current_settings(self):
        """åˆ·æ–°å½“å‰è®¾ç½®"""
        # è®¾ç½®å½“å‰ä¸»é¢˜
        current_theme = self.theme_manager.get_current_theme_name()
        for i in range(self.theme_combo.count()):
            if self.theme_combo.itemData(i) == current_theme:
                self.theme_combo.setCurrentIndex(i)
                break
        
        # è®¾ç½®å½“å‰æ¨¡å¼
        current_mode = self.theme_manager.get_current_mode()
        if current_mode == ThemeMode.LIGHT:
            self.mode_combo.setCurrentText("æµ…è‰²")
        else:
            self.mode_combo.setCurrentText("æ·±è‰²")
    
    def apply_theme(self):
        """åº”ç”¨ä¸»é¢˜"""
        # æš‚æ—¶æ–­å¼€ä¿¡å·ä»¥é˜²æ­¢å¾ªç¯è°ƒç”¨
        self.theme_manager.theme_changed.disconnect()
        self.theme_manager.mode_changed.disconnect()
        
        try:
            # è·å–é€‰æ‹©çš„ä¸»é¢˜
            theme_id = self.theme_combo.currentData()
            if theme_id:
                self.theme_manager.set_theme(theme_id)
                self.theme_changed.emit(theme_id)
            
            # è·å–é€‰æ‹©çš„æ¨¡å¼
            mode_text = self.mode_combo.currentText()
            mode = ThemeMode.LIGHT if mode_text == "æµ…è‰²" else ThemeMode.DARK
            self.theme_manager.set_mode(mode)
            self.mode_changed.emit(mode.value)
        finally:
            # é‡æ–°è¿æ¥ä¿¡å·
            self.theme_manager.theme_changed.connect(self.on_theme_manager_changed)
            self.theme_manager.mode_changed.connect(self.on_mode_manager_changed)
    
    def on_theme_changed(self, theme_name: str):
        """ä¸»é¢˜æ”¹å˜æ—¶çš„å¤„ç†"""
        pass
    
    def on_mode_changed(self, mode_text: str):
        """æ¨¡å¼æ”¹å˜æ—¶çš„å¤„ç†"""
        pass
    
    def on_theme_manager_changed(self, theme_name: str):
        """ä¸»é¢˜ç®¡ç†å™¨ä¸»é¢˜å˜æ›´æ—¶çš„å¤„ç†"""
        self.refresh_current_settings()
    
    def on_mode_manager_changed(self, mode_value: str):
        """ä¸»é¢˜ç®¡ç†å™¨æ¨¡å¼å˜æ›´æ—¶çš„å¤„ç†"""
        self.refresh_current_settings()


class CompactThemeSwitcher(QFrame):
    """ç´§å‡‘ç‰ˆä¸»é¢˜åˆ‡æ¢å™¨"""
    
    theme_changed = Signal(str)
    mode_changed = Signal(str)
    
    def __init__(self, theme_manager: ThemeManager, parent=None):
        super().__init__(parent)
        self.theme_manager = theme_manager
        self.setup_ui()
        self.connect_signals()
    
    def setup_ui(self):
        """è®¾ç½®ç•Œé¢"""
        layout = QHBoxLayout(self)
        layout.setContentsMargins(4, 4, 4, 4)
        layout.setSpacing(8)
        
        # ä¸»é¢˜é€‰æ‹©
        self.theme_combo = QComboBox()
        self.theme_combo.setMinimumWidth(120)
        layout.addWidget(self.theme_combo)
        
        # æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        self.mode_btn = QPushButton("ğŸŒ™")
        self.mode_btn.setMaximumWidth(32)
        self.mode_btn.setToolTip("åˆ‡æ¢æµ…è‰²/æ·±è‰²æ¨¡å¼")
        layout.addWidget(self.mode_btn)
        
        # åŠ è½½æ•°æ®
        self.refresh_themes()
        self.refresh_current_settings()
    
    def connect_signals(self):
        """è¿æ¥ä¿¡å·"""
        self.theme_combo.currentTextChanged.connect(self.apply_theme)
        self.mode_btn.clicked.connect(self.toggle_mode)
        
        # è¿æ¥ä¸»é¢˜ç®¡ç†å™¨çš„ä¿¡å·
        self.theme_manager.theme_changed.connect(self.on_theme_manager_changed)
        self.theme_manager.mode_changed.connect(self.on_mode_manager_changed)
        
    def on_theme_manager_changed(self, theme_name: str):
        """ä¸»é¢˜ç®¡ç†å™¨ä¸»é¢˜å˜æ›´æ—¶çš„å¤„ç†"""
        self.refresh_current_settings()
    
    def on_mode_manager_changed(self, mode_value: str):
        """ä¸»é¢˜ç®¡ç†å™¨æ¨¡å¼å˜æ›´æ—¶çš„å¤„ç†"""
        self.refresh_current_settings()
    
    def refresh_themes(self):
        """åˆ·æ–°ä¸»é¢˜åˆ—è¡¨"""
        self.theme_combo.clear()
        themes = self.theme_manager.get_available_themes()
        for theme_id, theme_name in themes.items():
            self.theme_combo.addItem(theme_name, theme_id)
    
    def refresh_current_settings(self):
        """åˆ·æ–°å½“å‰è®¾ç½®"""
        # è®¾ç½®å½“å‰ä¸»é¢˜
        current_theme = self.theme_manager.get_current_theme_name()
        for i in range(self.theme_combo.count()):
            if self.theme_combo.itemData(i) == current_theme:
                self.theme_combo.setCurrentIndex(i)
                break
        
        # æ›´æ–°æ¨¡å¼æŒ‰é’®
        current_mode = self.theme_manager.get_current_mode()
        if current_mode == ThemeMode.LIGHT:
            self.mode_btn.setText("ğŸŒ™")
            self.mode_btn.setToolTip("åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼")
        else:
            self.mode_btn.setText("â˜€ï¸")
            self.mode_btn.setToolTip("åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼")
    
    def apply_theme(self):
        """åº”ç”¨ä¸»é¢˜"""
        # æš‚æ—¶æ–­å¼€ä¿¡å·ä»¥é˜²æ­¢å¾ªç¯è°ƒç”¨
        self.theme_manager.theme_changed.disconnect()
        
        try:
            theme_id = self.theme_combo.currentData()
            if theme_id:
                self.theme_manager.set_theme(theme_id)
                self.theme_changed.emit(theme_id)
        finally:
            # é‡æ–°è¿æ¥ä¿¡å·
            self.theme_manager.theme_changed.connect(self.on_theme_manager_changed)
    
    def toggle_mode(self):
        """åˆ‡æ¢æ¨¡å¼"""
        # æš‚æ—¶æ–­å¼€ä¿¡å·ä»¥é˜²æ­¢å¾ªç¯è°ƒç”¨
        self.theme_manager.mode_changed.disconnect()
        
        try:
            current_mode = self.theme_manager.get_current_mode()
            new_mode = ThemeMode.DARK if current_mode == ThemeMode.LIGHT else ThemeMode.LIGHT
            self.theme_manager.set_mode(new_mode)
            self.mode_changed.emit(new_mode.value)
            
            # æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            self.refresh_current_settings()
        finally:
            # é‡æ–°è¿æ¥ä¿¡å·
            self.theme_manager.mode_changed.connect(self.on_mode_manager_changed)
